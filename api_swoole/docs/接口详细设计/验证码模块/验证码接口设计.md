# 验证码模块接口详细设计

## 一、模块概述

| 项目 | 说明 |
|------|------|
| 所属模块 | 基础模块 - 验证码管理 |
| 模块路径 | /basic/common/verifyCode |
| 接口数量 | 3个 |
| 需要认证 | 否（所有接口均无需认证） |
| 源文件 | VerifyCodeController.java |

---

## 二、接口列表

| 序号 | 接口路径 | 请求方式 | 功能描述 |
|------|----------|----------|----------|
| 1 | /basic/common/verifyCode/img | POST | 获取图片验证码 |
| 2 | /basic/common/verifyCode/phone | POST | 获取手机验证码 |
| 3 | /basic/common/verifyCode/email | POST | 获取邮件验证码 |

---

## 三、接口详细设计

### 3.1 获取图片验证码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/common/verifyCode/img |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 否 |

#### 请求参数
无

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "img": "data:image/png;base64,iVBORw0KGgo...",
        "key": "abc123def456"
    }
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| img | string | Base64编码的验证码图片，格式为 data:image/png;base64,{base64字符串} |
| key | string | 验证码唯一标识，用于后续验证 |

#### 业务逻辑流程
1. 生成验证码唯一标识（UUID）
2. 根据配置的验证码类型（math/char）生成验证码
   - math类型：生成数学运算表达式，如 "1+2=?"
   - char类型：生成随机字符串
3. 如果是debug模式，使用固定验证码 "12345"
4. 生成验证码图片（BufferedImage）
5. 将验证码答案存入Redis，有效期2分钟
   - key: {verifyKey}
   - value: {验证码答案}
   - 过期时间: 2分钟
6. 将图片转换为Base64字符串
7. 返回图片和key

#### 参数校验规则
无

#### 异常情况
| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 500 | 生成验证码图片失败 | 图片生成或编码失败 |

---

### 3.2 获取手机验证码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/common/verifyCode/phone |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 否 |

#### 请求参数
```json
{
    "phoneNumber": "13800138000"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phoneNumber | string | 是 | 手机号码 |

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": null
}
```

#### 业务逻辑流程
1. **频率限制检查**（check方法）
   - 检查1分钟内是否已发送过验证码
     - Redis key: `phone_code_one_minutes_cnt_{phoneNumber}`
     - 如果存在，抛出异常"1分钟内只能发送1次验证码"
   - 检查1小时内发送次数是否达到5次
     - Redis key: `phone_code_one_hour_cnt_{phoneNumber}`
     - 如果 >= 5，抛出异常"1小时内只能发送5次验证码"
   - 检查1天内发送次数是否达到10次
     - Redis key: `phone_code_one_day_cnt_{phoneNumber}`
     - 如果 >= 10，抛出异常"1天内只能发送10次验证码"

2. **生成并发送验证码**（service方法）
   - 生成6位数字验证码
   - 如果是debug模式，使用固定验证码 "123456"
   - 将验证码存入Redis，有效期2分钟
     - key: `phone_code_{phoneNumber}`
     - value: {6位验证码}
     - 过期时间: 2分钟
   - 更新发送次数计数器
     - 1分钟计数器：过期时间1分钟
     - 1小时计数器：过期时间1小时，累加计数
     - 1天计数器：过期时间1天，累加计数
   - 调用短信发送服务（TODO：需要对接短信服务商）

#### 参数校验规则
| 参数 | 校验规则 | 错误信息 |
|------|----------|----------|
| phoneNumber | 非空 | 手机号不能为空 |

#### 异常情况
| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 500 | 1分钟内只能发送1次验证码 | 频率限制 |
| 500 | 1小时内只能发送5次验证码 | 频率限制 |
| 500 | 1天内只能发送10次验证码 | 频率限制 |

---

### 3.3 获取邮件验证码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/common/verifyCode/email |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 否 |

#### 请求参数
```json
{
    "email": "user@example.com"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 是 | 邮箱地址 |

#### 返回结果
```json
{
    "code": 0,
    "message": "发送成功",
    "data": {
        "key": "abc123def456"
    }
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| key | string | 验证码唯一标识，用于后续验证 |

#### 业务逻辑流程
1. **参数预处理**
   - 去除邮箱地址前后空格

2. **生成并发送验证码**
   - 生成验证码唯一标识（UUID）
   - 生成6位数字验证码
   - 如果是debug模式，使用固定验证码 "123456"
   - 将验证码存入Redis，有效期30分钟
     - key: {verifyKey}
     - value: {6位验证码}
     - 过期时间: 30分钟
   - 发送HTML格式邮件
     - 收件人: {email}
     - 主题: "注册验证码"
     - 内容: `<h1>您的验证码：</h1>{code}<h3>有效期5分钟<h3>`
   - 返回验证码key

#### 参数校验规则
| 参数 | 校验规则 | 错误信息 |
|------|----------|----------|
| email | 非空 | 邮箱不能为空 |

#### 异常情况
| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 500 | 发送失败 | 邮件发送失败 |

---

## 四、Redis Key 设计

| Key 格式 | 用途 | 过期时间 |
|----------|------|----------|
| {uuid} | 图片验证码答案 | 2分钟 |
| phone_code_{phoneNumber} | 手机验证码 | 2分钟 |
| phone_code_one_minutes_cnt_{phoneNumber} | 1分钟发送次数 | 1分钟 |
| phone_code_one_hour_cnt_{phoneNumber} | 1小时发送次数 | 1小时 |
| phone_code_one_day_cnt_{phoneNumber} | 1天发送次数 | 1天 |
| {uuid} | 邮箱验证码 | 30分钟 |

---

## 五、Swoole实现规划

### 5.1 目录结构
```
api_swoole/app/Modules/VerifyCode/
├── Controller/
│   └── Http/
│       ├── Img.php           # 图片验证码
│       ├── Phone.php         # 手机验证码
│       └── Email.php         # 邮件验证码
├── Service/
│   └── VerifyCodeService.php # 验证码服务类
└── Routes/
    └── HTTP.php              # 路由定义
```

### 5.2 路由定义
```php
Route::setRequestType('http');
Route::prefix('basic/common/verifyCode')->group(function(){
    Route::post('img', App\Modules\VerifyCode\Controller\Http\Img::class);
    Route::post('phone', App\Modules\VerifyCode\Controller\Http\Phone::class);
    Route::post('email', App\Modules\VerifyCode\Controller\Http\Email::class);
});
```

### 5.3 依赖组件
- Redis: 用于存储验证码
- Kaptcha或类似库: 用于生成验证码图片
- PHPMailer或Swoole邮件组件: 用于发送邮件
