# 上传模块接口详细设计

## 一、模块概述

| 项目 | 说明 |
|------|------|
| 所属模块 | 基础模块 - 文件上传 |
| 模块路径 | /basic/common/upload |
| 接口数量 | 2个 |
| 需要认证 | 否（所有接口均无需认证） |
| 源文件 | UploadController.java |

---

## 二、接口列表

| 序号 | 接口路径 | 请求方式 | 功能描述 |
|------|----------|----------|----------|
| 1 | /basic/common/upload/img | POST | 上传图片 |
| 2 | /basic/common/upload/file | POST | 上传文件 |

---

## 三、接口详细设计

### 3.1 上传图片

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/common/upload/img |
| 请求方式 | POST |
| Content-Type | multipart/form-data |
| 需要认证 | 否 |

#### 请求参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | File | 是 | 图片文件 |

#### 返回结果
```json
{
    "code": 0,
    "message": "上传成功",
    "data": {
        "url": "http://example.com/uploads/20260205/abc123.jpg",
        "fileName": "abc123.jpg",
        "fileInfoId": "http://example.com/uploads/20260205/abc123.jpg",
        "fullUrl": "http://example.com/uploads/20260205/abc123.jpg"
    }
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| url | string | 文件访问URL |
| fileName | string | 生成的文件名 |
| fileInfoId | string | 文件标识（与url相同） |
| fullUrl | string | 完整访问URL |

#### 参数校验规则
| 校验项 | 规则 | 错误信息 |
|--------|------|----------|
| 文件非空 | file不为空 | 文件为空 |
| 文件类型 | Content-Type以image/开头 | 文件类型不正确，只允许上传图片 |
| 文件扩展名 | jpg/jpeg/png/gif/bmp/svg | 文件类型不正确，只允许上传图片 |
| 文件大小 | 不超过20MB | 文件大小超过20MB限制 |

#### 业务逻辑流程
1. 检查文件是否为空
2. 获取文件扩展名，验证是否为允许的图片格式
3. 验证Content-Type是否以image/开头
4. 检查文件大小是否超过限制（默认20MB）
5. 生成唯一文件名（UUID + 扩展名）
6. 根据存储配置选择存储方式：
   - local: 本地存储
   - aliyunOSS: 阿里云OSS
   - selfOSS: 自建S3兼容存储
7. 如果是图片且非SVG格式，进行压缩处理（质量0.8）
8. 返回文件URL

---

### 3.2 上传文件

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/common/upload/file |
| 请求方式 | POST |
| Content-Type | multipart/form-data |
| 需要认证 | 否 |

#### 请求参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | File | 是 | 任意文件 |

#### 返回结果
```json
{
    "code": 0,
    "message": "上传成功",
    "data": {
        "url": "http://example.com/uploads/20260205/abc123.pdf",
        "fileName": "abc123.pdf",
        "fileInfoId": "http://example.com/uploads/20260205/abc123.pdf",
        "fullUrl": "http://example.com/uploads/20260205/abc123.pdf"
    }
}
```

#### 参数校验规则
| 校验项 | 规则 | 错误信息 |
|--------|------|----------|
| 文件非空 | file不为空 | 文件为空 |
| 文件大小 | 不超过50MB | 文件大小超过50MB限制 |

#### 业务逻辑流程
1. 检查文件是否为空
2. 检查文件大小是否超过限制（默认50MB）
3. 生成唯一文件名（UUID + 扩展名）
4. 根据存储配置选择存储方式
5. 直接写入文件（不压缩）
6. 返回文件URL

---

## 四、存储配置

### 4.1 存储类型配置
| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| config.upload.storage_type | 存储类型 | local |
| config.upload.img_max_size | 图片最大大小 | 20971520 (20MB) |
| config.upload.file_max_size | 文件最大大小 | 52428800 (50MB) |

### 4.2 本地存储
- 存储目录: uploads/{yyyyMMdd}/
- 访问URL: {api_domain}/uploads/{yyyyMMdd}/{fileName}

### 4.3 阿里云OSS
| 配置项 | 说明 |
|--------|------|
| aliyun.oss.endpoint | OSS端点 |
| aliyun.oss.bucket-name | 存储桶名称 |
| config.upload.oss_root_dir | 根目录 |

### 4.4 自建S3存储
| 配置项 | 说明 |
|--------|------|
| selfS3.endpoint | S3端点 |
| selfS3.access_key | 访问密钥 |
| selfS3.secret_key | 密钥 |
| selfS3.bucket | 存储桶 |
| selfS3.access_domain | 访问域名 |

---

## 五、Swoole实现规划

### 5.1 目录结构
```
api_swoole/app/Modules/Upload/
├── Controller/
│   └── Http/
│       ├── Img.php           # 上传图片
│       └── File.php          # 上传文件
├── Service/
│   └── UploadService.php     # 上传服务类
└── Routes/
    └── HTTP.php              # 路由定义
```

### 5.2 路由定义
```php
Route::setRequestType('http');
Route::prefix('basic/common/upload')->group(function(){
    Route::post('img', App\Modules\Upload\Controller\Http\Img::class);
    Route::post('file', App\Modules\Upload\Controller\Http\File::class);
});
```

### 5.3 允许的图片扩展名
- jpg
- jpeg
- png
- gif
- bmp
- svg
