# 认证模块接口详细设计

## 一、模块概述

| 项目 | 说明 |
|------|------|
| 所属模块 | 认证授权模块 |
| 模块路径 | /basic/auth |
| 接口数量 | 14个 |
| 源文件 | LoginController.java, RegController.java, OtherController.java, ResetPwdController.java |

---

## 二、接口列表

### 2.1 登录接口 (/basic/auth/login)

| 序号 | 接口路径 | 请求方式 | 功能描述 | 需认证 |
|------|----------|----------|----------|--------|
| 1 | /basic/auth/login/username | POST | 用户名密码登录 | 否 |
| 2 | /basic/auth/login/email | POST | 邮箱密码登录 | 否 |
| 3 | /basic/auth/login/usernameVerCode | POST | 用户名密码+验证码登录 | 否 |
| 4 | /basic/auth/login/phone | POST | 手机验证码登录 | 否 |
| 5 | /basic/auth/login/wujieUnionId | POST | 无界unionid登录 | 否 |
| 6 | /basic/auth/login/wechatoffice | GET | 微信公众号登录 | 否 |
| 7 | /basic/auth/login/wechatmp | GET | 小程序登录 | 否 |

### 2.2 注册接口 (/basic/auth/reg)

| 序号 | 接口路径 | 请求方式 | 功能描述 | 需认证 |
|------|----------|----------|----------|--------|
| 8 | /basic/auth/reg/username | POST | 用户名密码注册 | 否 |
| 9 | /basic/auth/reg/email | POST | 邮箱密码+验证码注册 | 否 |

### 2.3 密码重置接口 (/basic/auth/resetPwd)

| 序号 | 接口路径 | 请求方式 | 功能描述 | 需认证 |
|------|----------|----------|----------|--------|
| 10 | /basic/auth/resetPwd/email | POST | 邮箱验证码重置密码 | 否 |

### 2.4 其他认证接口 (/basic/auth)

| 序号 | 接口路径 | 请求方式 | 功能描述 | 需认证 |
|------|----------|----------|----------|--------|
| 11 | /basic/auth/logout | POST | 退出登录 | 是 |
| 12 | /basic/auth/refresh | POST | 刷新token | 是 |
| 13 | /basic/auth/menus | POST | 获取用户菜单 | 是 |
| 14 | /basic/auth/codes | POST | 获取用户权限码 | 是 |

---

## 三、接口详细设计

### 3.1 用户名密码登录

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/login/username |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 否 |

#### 请求参数
```json
{
    "username": "admin",
    "password": "123456",
    "clientFrom": "web"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码（明文） |
| clientFrom | string | 否 | 客户端来源（web/app/miniapp等） |

#### 返回结果
```json
{
    "code": 0,
    "message": "登录成功",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR..."
    }
}
```

#### 业务逻辑流程
1. 去除用户名和密码的前后空格
2. 根据用户名查询用户信息
3. 验证用户是否存在
4. 验证用户状态（是否禁用/注销）
5. 验证密码（MD5加密后比对）
6. 登录成功，生成Token并返回

#### 参数校验规则
| 参数 | 校验规则 | 错误信息 |
|------|----------|----------|
| username | 非空 | 用户名不能为空 |
| password | 非空 | 密码不能为空 |

#### 异常情况
| 错误信息 | 说明 |
|----------|------|
| 账号不存在 | 用户名未找到 |
| 账号已禁用 | 用户状态为禁用 |
| 账号已注销 | 用户状态为注销 |
| 密码错误 | 密码不匹配 |

---

### 3.2 邮箱密码登录

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/login/email |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 否 |

#### 请求参数
```json
{
    "email": "user@example.com",
    "password": "123456",
    "clientFrom": "web"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 是 | 邮箱地址 |
| password | string | 是 | 密码（明文） |
| clientFrom | string | 否 | 客户端来源 |

#### 业务逻辑流程
与用户名登录类似，改为通过邮箱查询用户

---

### 3.3 用户名密码+验证码登录

#### 请求参数
```json
{
    "username": "admin",
    "password": "123456",
    "verifyKey": "abc123",
    "verifyCode": "1234",
    "clientFrom": "web"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| verifyKey | string | 是 | 验证码key |
| verifyCode | string | 是 | 验证码 |
| clientFrom | string | 否 | 客户端来源 |

#### 业务逻辑流程
1. 验证图片验证码是否正确
2. 执行用户名密码登录流程

---

### 3.4 手机验证码登录

#### 请求参数
```json
{
    "phoneNumber": "13800138000",
    "verifyCode": "123456",
    "clientFrom": "app"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| phoneNumber | string | 是 | 手机号 |
| verifyCode | string | 是 | 短信验证码 |
| clientFrom | string | 否 | 客户端来源 |

#### 业务逻辑流程
1. 验证短信验证码
2. 根据手机号查询用户
3. 用户不存在则自动注册
4. 登录成功返回Token

---

### 3.5 用户名密码注册

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/reg/username |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 否 |

#### 请求参数
```json
{
    "username": "newuser",
    "password": "123456"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名 |
| password | string | 是 | 密码 |

#### 返回结果
```json
{
    "code": 0,
    "message": "注册成功",
    "data": null
}
```

#### 业务逻辑流程
1. 检查用户名是否已存在
2. 密码MD5加密
3. 生成邀请码
4. 创建用户记录
5. 返回注册成功

---

### 3.6 退出登录

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/logout |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "clientFrom": "web"
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "退出成功",
    "data": null
}
```

---

### 3.7 刷新Token

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/refresh |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 返回结果
```json
{
    "code": 0,
    "message": "刷新成功",
    "data": {
        "accessToken": "eyJhbGciOiJIUzI1NiIsInR..."
    }
}
```

---

### 3.8 获取用户菜单

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/menus |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": [
        {
            "id": 1,
            "name": "系统管理",
            "path": "/system",
            "icon": "setting",
            "children": [...]
        }
    ]
}
```

---

### 3.9 获取用户权限码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/auth/codes |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": ["user:add", "user:edit", "user:delete", ...]
}
```

---

## 四、数据库表

### 4.1 用户表 (tb_basic_sys_user)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键ID |
| username | varchar | 用户名 |
| password | varchar | 密码(MD5) |
| email | varchar | 邮箱 |
| phone | varchar | 手机号 |
| status | int | 状态(0:正常 1:禁用 2:注销) |
| invite_code | varchar | 邀请码 |
| department_id | int | 部门ID |
| source | int | 注册来源 |
| created_at | datetime | 创建时间 |

---

## 五、Swoole实现规划

### 5.1 目录结构
```
api_swoole/app/Modules/Auth/
├── Controller/
│   └── Http/
│       ├── Login/
│       │   ├── Username.php      # 用户名登录
│       │   ├── Email.php         # 邮箱登录
│       │   ├── UsernameVerCode.php # 用户名+验证码登录
│       │   ├── Phone.php         # 手机验证码登录
│       │   ├── WujieUnionId.php  # 无界unionid登录
│       │   ├── WechatOffice.php  # 微信公众号登录
│       │   └── WechatMp.php      # 小程序登录
│       ├── Reg/
│       │   ├── Username.php      # 用户名注册
│       │   └── Email.php         # 邮箱注册
│       ├── ResetPwd/
│       │   └── Email.php         # 邮箱重置密码
│       ├── Logout.php            # 退出登录
│       ├── Refresh.php           # 刷新Token
│       ├── Menus.php             # 获取菜单
│       └── Codes.php             # 获取权限码
├── Service/
│   └── AuthService.php           # 认证服务类
└── Routes/
    └── HTTP.php                  # 路由定义
```

### 5.2 路由定义
```php
Route::setRequestType('http');

// 登录路由
Route::prefix('basic/auth/login')->group(function(){
    Route::post('username', App\Modules\Auth\Controller\Http\Login\Username::class);
    Route::post('email', App\Modules\Auth\Controller\Http\Login\Email::class);
    Route::post('usernameVerCode', App\Modules\Auth\Controller\Http\Login\UsernameVerCode::class);
    Route::post('phone', App\Modules\Auth\Controller\Http\Login\Phone::class);
    Route::post('wujieUnionId', App\Modules\Auth\Controller\Http\Login\WujieUnionId::class);
    Route::get('wechatoffice', App\Modules\Auth\Controller\Http\Login\WechatOffice::class);
    Route::get('wechatmp', App\Modules\Auth\Controller\Http\Login\WechatMp::class);
});

// 注册路由
Route::prefix('basic/auth/reg')->group(function(){
    Route::post('username', App\Modules\Auth\Controller\Http\Reg\Username::class);
    Route::post('email', App\Modules\Auth\Controller\Http\Reg\Email::class);
});

// 密码重置路由
Route::prefix('basic/auth/resetPwd')->group(function(){
    Route::post('email', App\Modules\Auth\Controller\Http\ResetPwd\Email::class);
});

// 其他认证路由
Route::prefix('basic/auth')->group(function(){
    Route::post('logout', App\Modules\Auth\Controller\Http\Logout::class);
    Route::post('refresh', App\Modules\Auth\Controller\Http\Refresh::class);
    Route::post('menus', App\Modules\Auth\Controller\Http\Menus::class);
    Route::post('codes', App\Modules\Auth\Controller\Http\Codes::class);
});
```
