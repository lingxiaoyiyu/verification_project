# 用户管理模块接口详细设计

## 一、模块概述

| 项目 | 说明 |
|------|------|
| 所属模块 | 用户管理模块 |
| 模块路径 | /basic/sys/user |
| 接口数量 | 15个 |
| 源文件 | UserController.java |

---

## 二、接口列表

| 序号 | 接口路径 | 请求方式 | 功能描述 | 需认证 |
|------|----------|----------|----------|--------|
| 1 | /basic/sys/user/add | POST | 添加用户 | 是 |
| 2 | /basic/sys/user/update/byId | POST | 更新指定用户信息 | 是 |
| 3 | /basic/sys/user/update/current | POST | 更新当前用户信息 | 是 |
| 4 | /basic/sys/user/update/status | POST | 修改用户状态 | 是 |
| 5 | /basic/sys/user/update/password/byId | POST | 管理员修改密码 | 是 |
| 6 | /basic/sys/user/update/password/current | POST | 用户修改自己密码 | 是 |
| 7 | /basic/sys/user/page | POST | 用户分页列表 | 是 |
| 8 | /basic/sys/user/get/byId | POST | 获取指定用户详情 | 是 |
| 9 | /basic/sys/user/get/current | POST | 获取当前用户详情 | 是 |
| 10 | /basic/sys/user/isExist | POST | 判断属性是否存在 | 是 |
| 11 | /basic/sys/user/online/page | POST | 在线用户分页 | 是 |
| 12 | /basic/sys/user/online/terminalList | POST | 获取终端列表 | 是 |
| 13 | /basic/sys/user/online/kickout | POST | 踢人下线 | 是 |
| 14 | /basic/sys/user/friend | POST | 获取好友列表 | 是 |
| 15 | /basic/sys/user/update/bindInviteCode | POST | 绑定邀请码 | 是 |

---

## 三、接口详细设计

### 3.1 添加用户

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/add |
| 请求方式 | POST |
| Content-Type | application/json |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "username": "test123",
    "password": "123456",
    "phoneNumber": "13800138000",
    "email": "test@example.com",
    "realName": "张三",
    "nickName": "小三",
    "roleIds": [1, 2],
    "status": 0,
    "remark": "测试用户",
    "departmentId": 1
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 是 | 用户名(3-32字符) |
| password | string | 是 | 密码(6-64字符) |
| phoneNumber | string | 否 | 手机号 |
| email | string | 否 | 邮箱(最长64字符) |
| realName | string | 否 | 真实姓名(最长32字符) |
| nickName | string | 否 | 昵称(最长32字符) |
| roleIds | array | 是 | 角色ID列表 |
| status | int | 否 | 状态(0正常 1禁用 2注销) |
| remark | string | 否 | 备注(最长255字符) |
| departmentId | int | 否 | 部门ID |

#### 返回结果
```json
{
    "code": 0,
    "message": "用户添加成功",
    "data": {
        "id": 123
    }
}
```

#### 业务逻辑
1. 检查用户名是否已存在
2. 检查手机号是否已存在（若提供）
3. 检查邮箱是否已存在（若提供）
4. 验证角色ID列表有效
5. 密码MD5加密
6. 生成6位邀请码
7. 创建用户记录
8. 添加用户角色关联

---

### 3.2 更新指定用户信息

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/update/byId |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "id": 1,
    "username": "test123",
    "phoneNumber": "13800138000",
    "email": "test@example.com",
    "realName": "张三",
    "nickName": "小三",
    "roleIds": [1, 2],
    "status": 0,
    "remark": "测试用户",
    "departmentId": 1,
    "updatedAt": "2025-02-05 12:00:00"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | int | 是 | 用户ID |
| username | string | 是 | 用户名 |
| phoneNumber | string | 否 | 手机号 |
| email | string | 否 | 邮箱 |
| realName | string | 否 | 真实姓名 |
| nickName | string | 否 | 昵称 |
| roleIds | array | 是 | 角色ID列表 |
| status | int | 否 | 状态 |
| remark | string | 否 | 备注 |
| departmentId | int | 否 | 部门ID |
| updatedAt | string | 否 | 更新时间(乐观锁) |

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "updatedAt": "2025-02-05 12:30:00"
    }
}
```

---

### 3.3 更新当前用户信息

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/update/current |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "nickName": "新昵称",
    "realName": "张三",
    "phoneNumber": "13800138000",
    "email": "test@example.com",
    "avatar": "http://example.com/avatar.jpg",
    "gender": 1,
    "introduction": "个人简介"
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "updatedAt": "2025-02-05 12:30:00"
    }
}
```

---

### 3.4 修改用户状态

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/update/status |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "id": 1,
    "status": 1,
    "updatedAt": "2025-02-05 12:00:00"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | int | 是 | 用户ID |
| status | int | 是 | 状态(0正常 1禁用 2注销) |
| updatedAt | string | 是 | 更新时间(乐观锁) |

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "updatedAt": "2025-02-05 12:30:00"
    }
}
```

---

### 3.5 管理员修改用户密码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/update/password/byId |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "id": 1,
    "password": "newpassword",
    "updatedAt": "2025-02-05 12:00:00"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | int | 是 | 用户ID |
| password | string | 是 | 新密码(6-20字符) |
| updatedAt | string | 否 | 更新时间(乐观锁) |

---

### 3.6 用户修改自己密码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/update/password/current |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "oldPassword": "oldpassword",
    "newPassword": "newpassword"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| oldPassword | string | 是 | 旧密码 |
| newPassword | string | 是 | 新密码(6-20字符) |

#### 业务逻辑
1. 获取当前用户ID
2. 验证旧密码是否正确
3. 新密码MD5加密后更新

---

### 3.7 用户分页列表

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/page |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "page": 1,
    "pageSize": 10,
    "username": "test",
    "realName": "张",
    "phoneNumber": "138",
    "email": "test",
    "nickName": "小",
    "status": 0,
    "roleIds": [1, 2],
    "departmentId": 1
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "list": [
            {
                "id": 1,
                "username": "admin",
                "nickName": "管理员",
                "realName": "管理员",
                "phoneNumber": "13800138000",
                "email": "admin@example.com",
                "status": 0,
                "departmentName": "技术部",
                "avatar": "http://...",
                "updatedAt": "2025-02-05 12:00:00",
                "roleNames": ["超级管理员"]
            }
        ],
        "total": 100
    }
}
```

---

### 3.8 获取指定用户详情

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/get/byId |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "id": 1
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "id": 1,
        "username": "admin",
        "nickName": "管理员",
        "realName": "管理员",
        "phoneNumber": "13800138000",
        "email": "admin@example.com",
        "avatar": "http://...",
        "status": 0,
        "gender": 1,
        "inviteCode": "ABC123",
        "introduction": "系统管理员",
        "departmentId": 1,
        "departmentName": "技术部",
        "createdAt": "2025-01-01 00:00:00",
        "updatedAt": "2025-02-05 12:00:00",
        "roleIds": [1],
        "roleNames": ["超级管理员"]
    }
}
```

---

### 3.9 获取当前用户详情

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/get/current |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
无

#### 返回结果
同3.8获取指定用户详情

---

### 3.10 判断属性是否存在

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/isExist |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "username": "test123",
    "nickname": "小三",
    "phoneNumber": "13800138000"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| username | string | 否 | 检查用户名 |
| nickname | string | 否 | 检查昵称 |
| phoneNumber | string | 否 | 检查手机号 |

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": null
}
```
注：若存在则返回错误信息

---

### 3.11 在线用户分页

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/online/page |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "page": 1,
    "pageSize": 10,
    "username": "test",
    "realName": "张"
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "list": [
            {
                "id": 1,
                "username": "admin",
                "nickName": "管理员",
                "realName": "管理员",
                "status": 0,
                "lastActiveAt": "2025-02-05 12:30:00",
                "clientForms": ["web", "mobile"]
            }
        ],
        "total": 50
    }
}
```

---

### 3.12 获取终端列表

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/online/terminalList |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "userId": 1
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": [
        {
            "token": "xxx",
            "clientFrom": "web",
            "lastActiveAt": "2025-02-05 12:30:00"
        }
    ]
}
```

---

### 3.13 踢人下线

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/online/kickout |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "kickoutToken": "token_xyz",
    "kickoutClientFrom": "web",
    "kickoutUserId": 1
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| kickoutToken | string | 否 | 按Token踢出 |
| kickoutClientFrom | string | 否 | 按终端类型踢出 |
| kickoutUserId | int | 否 | 按用户ID踢出全部 |

注：三个参数至少提供一个

---

### 3.14 获取好友列表

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/friend |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "page": 1,
    "pageSize": 10
}
```

#### 返回结果
```json
{
    "code": 0,
    "message": "success",
    "data": {
        "list": [...],
        "total": 20
    }
}
```

---

### 3.15 绑定邀请码

#### 基本信息
| 项目 | 说明 |
|------|------|
| 接口路径 | /basic/sys/user/update/bindInviteCode |
| 请求方式 | POST |
| 需要认证 | 是 |

#### 请求参数
```json
{
    "inviteCode": "ABC123"
}
```

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| inviteCode | string | 是 | 邀请码 |

#### 业务逻辑
1. 验证邀请码格式
2. 查找邀请码对应的用户
3. 绑定邀请关系

---

## 四、数据库表

### 4.1 用户表 (tb_basic_sys_user)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键ID |
| username | varchar | 用户名 |
| password | varchar | 密码(MD5) |
| email | varchar | 邮箱 |
| phone | varchar | 手机号 |
| nick_name | varchar | 昵称 |
| real_name | varchar | 真实姓名 |
| avatar | varchar | 头像URL |
| gender | tinyint | 性别(0未知 1男 2女) |
| status | tinyint | 状态(0正常 1禁用 2注销) |
| invite_code | varchar | 邀请码 |
| inviter_id | int | 邀请人ID |
| department_id | int | 部门ID |
| source | tinyint | 注册来源 |
| introduction | varchar | 个人简介 |
| remark | varchar | 备注 |
| created_at | datetime | 创建时间 |
| created_user_id | int | 创建人ID |
| updated_at | datetime | 更新时间 |
| updated_user_id | int | 更新人ID |

### 4.2 用户角色关联表 (tb_basic_sys_user_role_relation)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | int | 主键ID |
| user_id | int | 用户ID |
| role_id | int | 角色ID |

---

## 五、Swoole实现规划

### 5.1 目录结构
```
api_swoole/app/Modules/User/
├── Controller/
│   └── Http/
│       ├── Add.php                 # 添加用户
│       ├── Page.php                # 用户列表
│       ├── IsExist.php             # 判断存在
│       ├── Get/
│       │   ├── ById.php            # 获取指定用户
│       │   └── Current.php         # 获取当前用户
│       ├── Update/
│       │   ├── ById.php            # 更新指定用户
│       │   ├── Current.php         # 更新当前用户
│       │   ├── Status.php          # 更新状态
│       │   ├── BindInviteCode.php  # 绑定邀请码
│       │   └── Password/
│       │       ├── ById.php        # 修改指定用户密码
│       │       └── Current.php     # 修改自己密码
│       ├── Online/
│       │   ├── Page.php            # 在线用户列表
│       │   ├── TerminalList.php    # 终端列表
│       │   └── Kickout.php         # 踢人下线
│       └── Friend.php              # 好友列表
└── Routes/
    └── HTTP.php                    # 路由定义
```

### 5.2 路由定义
```php
Route::setRequestType('http');

Route::prefix('basic/sys/user')->group(function(){
    Route::post('add', App\Modules\User\Controller\Http\Add::class);
    Route::post('page', App\Modules\User\Controller\Http\Page::class);
    Route::post('isExist', App\Modules\User\Controller\Http\IsExist::class);
    Route::post('friend', App\Modules\User\Controller\Http\Friend::class);
    
    // 获取用户
    Route::post('get/byId', App\Modules\User\Controller\Http\Get\ById::class);
    Route::post('get/current', App\Modules\User\Controller\Http\Get\Current::class);
    
    // 更新用户
    Route::post('update/byId', App\Modules\User\Controller\Http\Update\ById::class);
    Route::post('update/current', App\Modules\User\Controller\Http\Update\Current::class);
    Route::post('update/status', App\Modules\User\Controller\Http\Update\Status::class);
    Route::post('update/bindInviteCode', App\Modules\User\Controller\Http\Update\BindInviteCode::class);
    Route::post('update/password/byId', App\Modules\User\Controller\Http\Update\Password\ById::class);
    Route::post('update/password/current', App\Modules\User\Controller\Http\Update\Password\Current::class);
    
    // 在线用户管理
    Route::post('online/page', App\Modules\User\Controller\Http\Online\Page::class);
    Route::post('online/terminalList', App\Modules\User\Controller\Http\Online\TerminalList::class);
    Route::post('online/kickout', App\Modules\User\Controller\Http\Online\Kickout::class);
});
```
