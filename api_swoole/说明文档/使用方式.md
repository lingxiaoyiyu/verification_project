# Cups Swoole 框架使用方式

## 一、脚本概述

`cups.sh` 是 Cups Swoole 框架的服务管理脚本，用于启动、停止、重启、重载和查看服务状态。该脚本封装了 Swoole 服务器的生命周期管理，提供了简洁的命令行接口。

---

## 二、脚本位置

```
api_swoole/cups.sh
```

---

## 三、命令列表

### 3.1 启动服务

```bash
./cups.sh start
```

**功能**：启动 Cups Swoole 服务，服务将在前台运行。

**输出示例**：
```
╔════════════════════════════════════════════════════════════════════════════════╗
║                   Swoole Server Started                                        ║
╠════════════════════════════════════════════════════════════════════════════════╣
║  Time:     2026-01-03 18:00:00                                                 ║
║  Server:   http://0.0.0.0:9501                                                 ║
║  Master:   PID: 12345                                                          ║
║  Manager:  PID: 12346                                                          ║
║  Worker:   Count: 4                                                            ║
║  Mode:     SWOOLE_BASE                                                         ║
╚════════════════════════════════════════════════════════════════════════════════╝
```

---

### 3.2 后台启动服务

```bash
./cups.sh start --daemon
# 或使用短选项
./cups.sh start -d
```

**功能**：启动 Cups Swoole 服务，服务将在后台运行。

**输出示例**：
```
Starting server  done
```

---

### 3.3 停止服务

```bash
./cups.sh stop
```

**功能**：优雅停止 Cups Swoole 服务，先尝试优雅停止进程，如失败则强制杀死。

**输出示例**：
```
Gracefully shutting down server  done
```

---

### 3.4 强制停止服务

```bash
./cups.sh force-quit
```

**功能**：强制停止服务，立即终止所有进程。

---

### 3.5 重启服务

```bash
./cups.sh restart
```

**功能**：先停止服务，再启动服务。适用于配置文件修改后需要重新加载的场景。

---

### 3.6 重载服务

```bash
./cups.sh reload
```

**功能**：平滑重载 Worker 进程，不中断现有连接。适用于代码更新后需要重新加载的场景。

**输出示例**：
```
Reload server ing... done
```

**使用场景**：
- 代码文件更新后
- 需要重新加载业务逻辑
- 不需要重启整个服务

---

### 3.7 重载任务进程

```bash
./cups.sh reloadtask
```

**功能**：重载 Task Worker 进程。

**输出示例**：
```
Reload task ing... done
```

---

### 3.8 查看服务状态

```bash
./cups.sh status
```

**功能**：查看服务是否正在运行，并显示进程树。

**输出示例**：
```
server is running

systemd-+-sshd---sshd---bash---cups.sh---php---php---php
        `-sshd---sshd---bash---pstree
```

---

### 3.9 查看版本信息

```bash
./cups.sh version
```

**功能**：查看 Cups Swoole 框架的版本信息。

**输出示例**：
```
Cups Swoole Framework Version: 1.0.0
```

---

## 四、配置选项

### 4.1 PHP 路径配置

脚本会自动查找 `swoole-cli` 或 `php`，也可以通过环境变量指定：

```bash
export PHP_BIN=/path/to/php
./cups.sh start
```

### 4.2 日志文件配置

日志文件默认存储在 `api_swoole/storage/logs/server.log`，可以通过环境变量修改：

```bash
export LOG_PATH=/path/to/logs
export LOG_FILE=$LOG_PATH/custom.log
./cups.sh start
```

### 4.3 环境变量配置

可以通过环境变量配置以下选项：

| 环境变量 | 描述 | 默认值 |
|---------|------|--------|
| `PHP_BIN` | PHP 执行路径 | 自动查找 |
| `BIN_PATH` | bin 目录路径 | 当前目录 |
| `SERVER_PATH` | 服务器根目录 | `BIN_PATH/..` |
| `APPLICATION_FILE` | 入口文件路径 | `SERVER_PATH/index.php` |
| `LOG_PATH` | 日志目录路径 | `SERVER_PATH/storage/logs` |
| `LOG_FILE` | 日志文件路径 | `LOG_PATH/server.log` |

---

## 五、服务器配置

### 5.1 配置文件位置

```
config/server.php
```

### 5.2 配置示例

```php
<?php
return [
    // 服务器监听地址
    'host' => '0.0.0.0',
    
    // 服务器监听端口
    'port' => 9501,
    
    // 运行模式：SWOOLE_PROCESS 或 SWOOLE_BASE
    'mode' => SWOOLE_BASE,
    
    // Socket 类型：SWOOLE_SOCK_TCP
    'sock_type' => SWOOLE_SOCK_TCP,
    
    // Worker 进程数
    'worker_num' => 4,
    
    // Task Worker 进程数
    'task_worker_num' => 2,
    
    // 是否开启守护进程
    'daemonize' => false,
    
    // 日志文件路径
    'log_file' => __DIR__ . '/../storage/logs/swoole.log',
    
    // PID 文件路径
    'pid_file' => __DIR__ . '/../bin/master.pid',
    
    // 心跳检测间隔（秒）
    'heartbeat_check_interval' => 60,
    
    // 心跳检测超时时间（秒）
    'heartbeat_idle_time' => 120,
    
    // 最大连接数
    'max_conn' => 10000,
    
    // 包解析最大长度
    'package_max_length' => 2097152, // 2MB
    
    // 开启协程
    'enable_coroutine' => true,
    
    // 协程堆栈大小
    'stack_size' => 2097152, // 2MB
    
    // CORS 跨域配置
    'cors' => [
        'origin' => '*',
        'methods' => 'GET, POST, PUT, DELETE, OPTIONS',
        'headers' => 'Content-Type, Authorization, X-Requested-With',
        'credentials' => 'true',
    ],
];
```

### 5.3 配置说明

| 配置项 | 说明 | 建议值 |
|--------|------|--------|
| `worker_num` | Worker 进程数 | CPU 核数的 2-4 倍 |
| `task_worker_num` | Task Worker 进程数 | 根据任务量设置 |
| `daemonize` | 是否守护进程 | 生产环境 `true` |
| `max_conn` | 最大连接数 | 根据服务器内存设置 |
| `heartbeat_check_interval` | 心跳检测间隔 | 60 秒 |

---

## 六、日志管理

### 6.1 日志文件位置

```
storage/logs/
├── server.log          # 服务器日志
├── 2026-01-03.log      # 应用日志（按日期）
├── emergency.log       # 紧急日志
└── framework_error.log # 框架错误日志
```

### 6.2 实时查看日志

```bash
# 查看服务器日志
tail -f storage/logs/server.log

# 查看应用日志
tail -f storage/logs/$(date +%Y-%m-%d).log

# 查看所有日志
tail -f storage/logs/*.log
```

### 6.3 日志轮转

框架支持自动日志轮转，配置 `config/log.php`：

```php
return [
    'max_files' => 30,  // 保留最近 30 天的日志
];
```

---

## 七、常见问题

### 7.1 服务无法启动

**可能原因**：
- PHP 或 swoole-cli 未安装或不在 PATH 中
- 入口文件不存在
- 日志目录无法创建
- 端口被占用

**解决方案**：
```bash
# 检查 PHP 是否安装
which php
which swoole-cli

# 检查入口文件
ls -l api_swoole/index.php

# 检查日志目录权限
chmod -R 755 api_swoole/storage/logs

# 检查端口占用
netstat -tlnp | grep 9501
lsof -i :9501
```

### 7.2 端口被占用

**错误信息**：
```
Fatal error: Port 9501 is already in use
```

**解决方案**：
```bash
# 查找占用端口的进程
lsof -i :9501

# 或
netstat -tlnp | grep 9501

# 结束进程
kill -9 <PID>

# 或修改配置文件使用其他端口
# config/server.php
'port' => 9502,
```

### 7.3 服务无法停止

**可能原因**：
- PID 文件不存在或为空
- 进程已被杀死，但 PID 文件未删除

**解决方案**：
```bash
# 手动查找并杀死进程
ps aux | grep php
kill -9 <PID>

# 删除 PID 文件
rm -f api_swoole/bin/master.pid
rm -f api_swoole/bin/manager.pid
rm -f api_swoole/bin/worker.pid
```

### 7.4 重载失败

**可能原因**：
- 服务未运行
- 管理进程 PID 无效

**解决方案**：
```bash
# 检查服务状态
./cups.sh status

# 重启服务
./cups.sh restart
```

### 7.5 内存溢出

**错误信息**：
```
Fatal error: Allowed memory size exhausted
```

**解决方案**：
```bash
# 修改 PHP 内存限制
export PHP_BIN="php -d memory_limit=512M"
./cups.sh start

# 或在 php.ini 中修改
memory_limit = 512M
```

---

## 八、最佳实践

### 8.1 生产环境配置

1. **指定明确的 PHP 路径**：
   ```bash
   export PHP_BIN=/usr/local/php/bin/swoole-cli
   ./cups.sh start --daemon
   ```

2. **配置日志文件路径**：
   ```bash
   export LOG_PATH=/var/log/cups-server
   export LOG_FILE=$LOG_PATH/server.log
   ./cups.sh start --daemon
   ```

3. **使用 systemd 管理服务**：

   创建 `/etc/systemd/system/cups.service`：
   ```ini
   [Unit]
   Description=Cups Swoole Server
   After=network.target

   [Service]
   Type=simple
   User=www-data
   Group=www-data
   WorkingDirectory=/path/to/api_swoole
   ExecStart=/path/to/api_swoole/cups.sh start
   ExecStop=/path/to/api_swoole/cups.sh stop
   ExecReload=/path/to/api_swoole/cups.sh reload
   Restart=always
   RestartSec=5

   [Install]
   WantedBy=multi-user.target
   ```

   启动服务：
   ```bash
   systemctl enable cups
   systemctl start cups
   systemctl status cups
   ```

### 8.2 开发环境配置

1. **使用默认配置**：
   ```bash
   ./cups.sh start
   ```

2. **开启热重载**：
   框架内置热重载功能，文件修改后自动重启 Worker。

3. **实时查看日志**：
   ```bash
   tail -f storage/logs/server.log
   ```

### 8.3 部署流程

```bash
# 1. 进入项目目录
cd /path/to/api_swoole

# 2. 安装依赖
composer install --no-dev --optimize-autoloader

# 3. 生成自动加载文件
composer dump-autoload --optimize

# 4. 设置目录权限
chmod -R 755 storage/logs
chmod -R 755 storage/cache

# 5. 停止旧服务
./cups.sh stop

# 6. 启动新服务
./cups.sh start --daemon

# 7. 检查服务状态
./cups.sh status
```

---

## 九、性能优化

### 9.1 Worker 进程数

根据 CPU 核数设置 Worker 数量：

```php
// config/server.php
'worker_num' => 4,  // CPU 核数的 2-4 倍
```

### 9.2 连接池配置

数据库和 Redis 连接池配置：

```php
// config/database.php
'pool' => [
    'min' => 5,    // 最小连接数
    'max' => 20,   // 最大连接数
],

// config/redis.php
'pool' => [
    'min' => 5,
    'max' => 20,
],
```

### 9.3 开启 OPCache

生产环境建议开启 OPCache：

```ini
; php.ini
opcache.enable=1
opcache.enable_cli=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.revalidate_freq=60
opcache.fast_shutdown=1
```

---

## 十、版本历史

| 版本 | 日期 | 描述 |
|------|------|------|
| 1.0.0 | 2026-02-05 | 初始版本，支持 HTTP/WebSocket 服务 |

---

## 十一、相关文档

- [框架说明.md](框架说明.md) - 框架整体架构和功能说明
- [Route门面使用说明.md](Route门面使用说明.md) - 路由系统使用说明
- [DB门面使用说明.md](DB门面使用说明.md) - 数据库操作说明
- [Request门面使用说明.md](Request门面使用说明.md) - HTTP 请求处理说明
- [PSR-3日志接口说明.md](PSR-3日志接口说明.md) - PSR-3 日志接口说明
- [PSR-4自动加载说明.md](PSR-4自动加载说明.md) - PSR-4 自动加载说明

---

© 2026 Cups Swoole Framework
