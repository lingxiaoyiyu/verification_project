# Validate 验证器使用说明

## 简介

Validate 是一个基于 Swoole 框架的强大表单数据验证类，提供了 38+ 种常用验证规则，支持自定义错误提示，完全适配门面模式。

## 基本用法

### 1. 引入验证器

```php
use Library\Core\Validate;
use Library\Facades\Request;
```

### 2. 创建验证实例

```php
$validate = new Validate();
```

### 3. 定义验证规则

```php
$rules = [
    'username' => ['text' => '用户名', 'rules' => ['required', ['min_length' => 3]]],
    'email' => ['text' => '邮箱', 'rules' => ['required', 'email']],
];
```

### 4. 执行验证

```php
try {
    $validate->validate($rules);
    // 验证通过
} catch (CupException $e) {
    // 验证失败，获取错误信息
    $errorMessage = $e->getMessage();
    $errorCode = $e->getCode();
}
```

## 规则配置格式

### 完整格式

```php
[
    '字段名' => [
        'text' => '字段显示名称',  // 用于错误提示
        'rules' => [              // 验证规则数组
            '规则1',
            ['规则2' => 参数],
            ['规则3' => [参数1, 参数2]]
        ]
    ]
]
```

### 简化格式

```php
// 无自定义显示名称
[
    '字段名' => [
        'required',
        ['min_length' => 3]
    ]
]

// 单个规则
[
    '字段名' => 'required'
]
```

## 验证规则大全

### 一、基础规则

#### required
必填验证，字段不能为空（正确处理 0 和 '0'）

```php
['username' => ['text' => '用户名', 'rules' => ['required']]]
```

#### file_required
文件必须上传

```php
['avatar' => ['text' => '头像', 'rules' => ['file_required']]]
```

---

### 二、字符串规则

#### min_length
最小长度（支持中文字符）

```php
['password' => ['text' => '密码', 'rules' => [['min_length' => 6]]]]
```

#### max_length
最大长度（支持中文字符）

```php
['username' => ['text' => '用户名', 'rules' => [['max_length' => 20]]]]
```

#### length
固定长度

```php
['code' => ['text' => '验证码', 'rules' => [['length' => 6]]]]
```

#### alpha
只能包含字母

```php
['name' => ['text' => '姓名', 'rules' => ['alpha']]]
```

#### alpha_num
只能包含字母和数字

```php
['username' => ['text' => '用户名', 'rules' => ['alpha_num']]]
```

#### alpha_dash
只能包含字母、数字、下划线和破折号

```php
['slug' => ['text' => 'URL标识', 'rules' => ['alpha_dash']]]
```

---

### 三、数值规则

#### is_numeric
必须是数字

```php
['price' => ['text' => '价格', 'rules' => ['is_numeric']]]
```

#### is_int / is_integer
必须是整数（支持别名）

```php
['age' => ['text' => '年龄', 'rules' => ['is_int']]]
```

#### is_float
必须是浮点数

```php
['rate' => ['text' => '比率', 'rules' => ['is_float']]]
```

#### min
最小值

```php
['age' => ['text' => '年龄', 'rules' => [['min' => 18]]]]
```

#### max
最大值

```php
['score' => ['text' => '分数', 'rules' => [['max' => 100]]]]
```

#### between
值在指定范围内

```php
['age' => ['text' => '年龄', 'rules' => [['between' => [18, 60]]]]]
```

---

### 四、数组规则

#### is_array
必须是数组

```php
['tags' => ['text' => '标签', 'rules' => ['is_array']]]
```

#### in_array
值必须在指定数组中

```php
['status' => ['text' => '状态', 'rules' => [['in_array' => [1, 2, 3]]]]]
```

#### not_in
值不能在指定数组中

```php
['username' => ['text' => '用户名', 'rules' => [['not_in' => ['admin', 'root']]]]]
```

---

### 五、类型规则

#### is_string
必须是字符串

```php
['name' => ['text' => '姓名', 'rules' => ['is_string']]]
```

#### is_bool / is_boolean
必须是布尔值（支持别名）

```php
['agree' => ['text' => '同意协议', 'rules' => ['is_bool']]]
```

---

### 六、正则规则

#### regex
自定义正则表达式验证

```php
['code' => ['text' => '邀请码', 'rules' => [['regex' => '/^[A-Z0-9]{8}$/']]]]
```

---

### 七、格式规则

#### phone / mobile
手机号验证（支持别名）

```php
['phone' => ['text' => '手机号', 'rules' => ['mobile']]]
```

#### email
邮箱地址验证

```php
['email' => ['text' => '邮箱', 'rules' => ['email']]]
```

#### url
URL地址验证

```php
['website' => ['text' => '网站', 'rules' => ['url']]]
```

#### ip
IP地址验证（支持 IPv4 和 IPv6）

```php
['ip' => ['text' => 'IP地址', 'rules' => ['ip']]]
```

#### ipv4
IPv4 地址验证

```php
['server_ip' => ['text' => '服务器IP', 'rules' => ['ipv4']]]
```

#### ipv6
IPv6 地址验证

```php
['ipv6_addr' => ['text' => 'IPv6地址', 'rules' => ['ipv6']]]
```

#### json
JSON 格式验证

```php
['config' => ['text' => '配置', 'rules' => ['json']]]
```

---

### 八、日期规则

#### date
日期格式验证

```php
['birthday' => ['text' => '生日', 'rules' => ['date']]]
```

#### date_format
指定日期格式验证

```php
['date' => ['text' => '日期', 'rules' => [['date_format' => 'Y-m-d']]]]
```

#### before
日期必须在指定日期之前

```php
['birthday' => ['text' => '生日', 'rules' => [['before' => '2020-01-01']]]]
```

#### after
日期必须在指定日期之后

```php
['start_date' => ['text' => '开始日期', 'rules' => [['after' => '2024-01-01']]]]
```

---

### 九、比较规则

#### confirmed
确认字段验证（自动查找 `字段名_confirmation`）

```php
// 验证 password 和 password_confirmation 是否一致
['password' => ['text' => '密码', 'rules' => ['confirmed']]]
```

#### same
与其他字段值相同

```php
['password_confirm' => ['text' => '确认密码', 'rules' => [['same' => 'password']]]]
```

#### different
与其他字段值不同

```php
['new_password' => ['text' => '新密码', 'rules' => [['different' => 'old_password']]]]
```

---

### 十、文件规则

#### file_extension
文件扩展名验证

```php
['avatar' => ['text' => '头像', 'rules' => [['file_extension' => ['jpg', 'png', 'gif']]]]]
```

#### file_size
文件大小验证（单位：字节）

```php
['file' => ['text' => '文件', 'rules' => [['file_size' => 2 * 1024 * 1024]]]] // 2MB
```

#### file_mime
文件 MIME 类型验证

```php
['document' => ['text' => '文档', 'rules' => [['file_mime' => ['application/pdf', 'application/msword']]]]]
```

#### image
图片文件验证（支持 jpeg、png、gif、bmp、webp）

```php
['photo' => ['text' => '照片', 'rules' => ['image']]]
```

---

### 十一、数据库规则（预留）

#### unique
唯一性验证（需自行实现）

```php
// 预留接口，需配合数据库使用
// ['email' => ['text' => '邮箱', 'rules' => [['unique' => ['users', 'email', $userId]]]]]
```

#### exists
存在性验证（需自行实现）

```php
// 预留接口，需配合数据库使用
// ['user_id' => ['text' => '用户ID', 'rules' => [['exists' => ['users', 'id']]]]]
```

---

## 完整示例

### 示例 1：用户注册验证

```php
use Library\Core\Validate;
use Library\Facades\Request;
use Library\Facades\Response;

public function register() {
    $validate = new Validate();
    
    try {
        $validate->validate([
            'username' => [
                'text' => '用户名',
                'rules' => [
                    'required',
                    'alpha_num',
                    ['min_length' => 3],
                    ['max_length' => 20]
                ]
            ],
            'password' => [
                'text' => '密码',
                'rules' => [
                    'required',
                    ['min_length' => 6],
                    ['max_length' => 32]
                ]
            ],
            'password_confirmation' => [
                'text' => '确认密码',
                'rules' => [
                    'required',
                    'confirmed'
                ]
            ],
            'email' => [
                'text' => '邮箱',
                'rules' => [
                    'required',
                    'email'
                ]
            ],
            'phone' => [
                'text' => '手机号',
                'rules' => [
                    'required',
                    'mobile'
                ]
            ],
            'age' => [
                'text' => '年龄',
                'rules' => [
                    'required',
                    'is_int',
                    ['between' => [18, 100]]
                ]
            ],
            'agree' => [
                'text' => '同意协议',
                'rules' => [
                    'required',
                    ['in_array' => [1, true]]
                ]
            ]
        ]);
        
        // 验证通过，处理注册逻辑
        $username = Request::all('username');
        $password = Request::all('password');
        // ... 注册逻辑
        
        Response::success(['user_id' => 123], '注册成功');
        
    } catch (CupException $e) {
        Response::fail($e->getMessage(), $e->getCode());
    }
}
```

### 示例 2：文件上传验证

```php
public function upload() {
    $validate = new Validate();
    
    try {
        $validate->validate([
            'avatar' => [
                'text' => '头像',
                'rules' => [
                    'file_required',
                    'image',
                    ['file_size' => 5 * 1024 * 1024], // 5MB
                    ['file_extension' => ['jpg', 'jpeg', 'png', 'gif']]
                ]
            ]
        ]);
        
        // 验证通过，处理上传逻辑
        $file = Request::file('avatar');
        // ... 上传逻辑
        
        Response::success(['url' => '/uploads/avatar.jpg'], '上传成功');
        
    } catch (CupException $e) {
        Response::fail($e->getMessage(), $e->getCode());
    }
}
```

### 示例 3：表单提交验证

```php
public function submit() {
    $validate = new Validate();
    
    try {
        $validate->validate([
            'title' => [
                'text' => '标题',
                'rules' => [
                    'required',
                    ['min_length' => 5],
                    ['max_length' => 100]
                ]
            ],
            'content' => [
                'text' => '内容',
                'rules' => [
                    'required',
                    ['min_length' => 10]
                ]
            ],
            'category_id' => [
                'text' => '分类',
                'rules' => [
                    'required',
                    'is_int',
                    ['in_array' => [1, 2, 3, 4, 5]]
                ]
            ],
            'tags' => [
                'text' => '标签',
                'rules' => [
                    'is_array'
                ]
            ],
            'publish_date' => [
                'text' => '发布日期',
                'rules' => [
                    'required',
                    'date',
                    ['after' => date('Y-m-d')]
                ]
            ],
            'website' => [
                'text' => '网站',
                'rules' => [
                    'url'
                ]
            ],
            'extra' => [
                'text' => '额外配置',
                'rules' => [
                    'json'
                ]
            ]
        ]);
        
        // 验证通过
        Response::success(null, '提交成功');
        
    } catch (CupException $e) {
        Response::fail($e->getMessage(), $e->getCode());
    }
}
```

### 示例 4：API 参数验证

```php
public function apiCreate() {
    $validate = new Validate();
    
    try {
        $validate->validate([
            'name' => [
                'text' => '名称',
                'rules' => [
                    'required',
                    'alpha_dash',
                    ['regex' => '/^[a-z][a-z0-9_-]*$/']
                ]
            ],
            'type' => [
                'text' => '类型',
                'rules' => [
                    'required',
                    ['in_array' => ['user', 'admin', 'guest']]
                ]
            ],
            'status' => [
                'text' => '状态',
                'rules' => [
                    'is_int',
                    ['in_array' => [0, 1]]
                ]
            ],
            'config' => [
                'text' => '配置',
                'rules' => [
                    'required',
                    'json'
                ]
            ],
            'ip_whitelist' => [
                'text' => 'IP白名单',
                'rules' => [
                    'is_array'
                ]
            ]
        ]);
        
        // 额外验证 IP 白名单中的每个 IP
        $ipList = Request::all('ip_whitelist', []);
        foreach ($ipList as $ip) {
            if (!filter_var($ip, FILTER_VALIDATE_IP)) {
                throw new CupException('IP白名单中包含无效的IP地址', Config::get("result.code.badRequest"));
            }
        }
        
        Response::success(null, '创建成功');
        
    } catch (CupException $e) {
        Response::fail($e->getMessage(), $e->getCode());
    }
}
```

## 最佳实践

### 1. 封装验证方法

```php
class UserController extends BaseController {
    
    private function validateRegister() {
        $validate = new Validate();
        $validate->validate([
            'username' => ['text' => '用户名', 'rules' => ['required', ['min_length' => 3]]],
            'email' => ['text' => '邮箱', 'rules' => ['required', 'email']],
            'password' => ['text' => '密码', 'rules' => ['required', ['min_length' => 6]]],
        ]);
    }
    
    public function register() {
        try {
            $this->validateRegister();
            // 处理注册逻辑
        } catch (CupException $e) {
            Response::fail($e->getMessage(), $e->getCode());
        }
    }
}
```

### 2. 创建验证器类

```php
// app/Validators/UserValidator.php
namespace App\Validators;

use Library\Core\Validate;

class UserValidator {
    
    public static function register() {
        $validate = new Validate();
        $validate->validate([
            'username' => ['text' => '用户名', 'rules' => ['required', 'alpha_num', ['min_length' => 3]]],
            'email' => ['text' => '邮箱', 'rules' => ['required', 'email']],
            'password' => ['text' => '密码', 'rules' => ['required', ['min_length' => 6]]],
            'password_confirmation' => ['text' => '确认密码', 'rules' => ['required', 'confirmed']],
        ]);
    }
    
    public static function login() {
        $validate = new Validate();
        $validate->validate([
            'username' => ['text' => '用户名', 'rules' => ['required']],
            'password' => ['text' => '密码', 'rules' => ['required']],
        ]);
    }
}
```

使用：

```php
use App\Validators\UserValidator;

public function register() {
    try {
        UserValidator::register();
        // 处理逻辑
    } catch (CupException $e) {
        Response::fail($e->getMessage(), $e->getCode());
    }
}
```

### 3. 配置错误码

在 `config/default.php` 中配置：

```php
return [
    'result' => [
        'code' => [
            'badRequest' => 400,
            'unauthorized' => 401,
            'forbidden' => 403,
            'notFound' => 404,
            'error' => 500,
            'success' => 0,
        ]
    ]
];
```

## 注意事项

1. **字符串长度**：`min_length`、`max_length`、`length` 使用 `mb_strlen()`，正确支持中文字符
2. **整数验证**：`is_int` 规则同时支持 `int` 类型和数字字符串
3. **必填验证**：`required` 规则正确处理 `0` 和 `'0'` 值
4. **文件验证**：使用 `Request::file()` 获取文件信息
5. **错误码配置**：所有验证错误使用 `Config::get("result.code.badRequest")` 获取错误码
6. **数据库规则**：`unique` 和 `exists` 规则预留接口，需自行实现具体逻辑

## 扩展自定义规则

如需添加自定义规则，在 `Validate::test()` 方法的 `switch` 语句中添加新的 `case`：

```php
case 'custom_rule':
    if (!$this->customValidate($value, $params)) {
        throw new CupException($fieldText . '自定义验证失败', Config::get("result.code.badRequest"));
    }
    break;
```

## 技术支持

- 文件路径：`d:\SVN_OTHER\basic\api_swoole\library\Core\Validate.php`
- 依赖：Request 门面类、Config 配置类、CupException 异常类
- 版本：适配 Swoole 协程环境

---

© 2026 Swoole Framework Validate Component
