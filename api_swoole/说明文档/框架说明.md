# Cups Swoole 框架说明

## 一、框架概述

Cups 是一个基于 Swoole 扩展的高性能 PHP 异步框架，采用协程化设计，支持 HTTP/WebSocket/TCP/UDP 多协议，内置连接池、路由系统、门面模式等特性。

### 1.1 核心特性

- **协程化架构**：基于 Swoole 协程实现高并发处理
- **多协议支持**：HTTP、WebSocket、TCP、UDP 统一处理
- **连接池管理**：MySQL、Redis 连接池，提升数据库访问性能
- **热重载机制**：开发环境下文件变更自动重启 Worker
- **门面模式**：简化 API 调用，提供类似 Laravel 的开发体验
- **PSR 兼容**：支持 PSR-3 日志接口和 PSR-4 自动加载规范
- **MVC 架构**：清晰的 Controller → Service → Model 分层

### 1.2 目录结构

```
api_swoole/
├── app/                    # 应用目录
│   ├── Base/              # 基础类
│   │   └── BaseController.php    # 控制器基类
│   ├── Controller/        # 控制器
│   ├── Service/           # 业务逻辑层
│   └── Model/             # 数据模型层
├── library/               # 框架核心库
│   ├── Cups.php          # 框架入口类
│   ├── Context/          # 协程上下文管理
│   ├── Core/             # 核心组件
│   │   ├── Config.php    # 配置管理
│   │   ├── Jwt.php       # JWT 认证
│   │   ├── ServerException.php  # 异常处理
│   │   ├── Validate.php  # 验证器
│   │   └── Server/       # 服务器实现
│   │       ├── BaseServer.php   # 服务器基类
│   │       └── ServerHttp.php   # HTTP 服务器
│   ├── Database/         # 数据库组件
│   │   ├── MysqlBuilder.php     # MySQL 查询构建器
│   │   ├── DbPoolConn.php       # 数据库连接池
│   │   └── BuilderInterface.php # 构建器接口
│   ├── Facades/          # 门面类
│   │   ├── DB.php        # 数据库门面
│   │   ├── Request.php   # 请求门面
│   │   ├── Response.php  # 响应门面
│   │   ├── Route.php     # 路由门面
│   │   ├── Redis.php     # Redis 门面
│   │   ├── Log.php       # 日志门面
│   │   └── Validate.php  # 验证门面
│   ├── Log/              # 日志组件
│   │   ├── Log.php       # 日志核心类
│   │   └── PsrLogger.php # PSR-3 日志实现
│   ├── Redis/            # Redis 组件
│   │   └── RedisPoolConn.php    # Redis 连接池
│   └── Route/            # 路由组件
│       └── Builder.php   # 路由构建器
├── config/               # 配置文件
│   ├── server.php        # 服务器配置
│   ├── database.php      # 数据库配置
│   ├── redis.php         # Redis 配置
│   └── log.php           # 日志配置
├── route/                # 路由定义
│   └── api.php           # API 路由
├── storage/              # 存储目录
│   └── logs/             # 日志文件
├── vendor/               # Composer 依赖
├── composer.json         # Composer 配置
├── .env                  # 环境变量
├── cups.sh               # 管理脚本
└── index.php             # 入口文件
```

---

## 二、入口文件 (index.php)

### 2.1 文件位置
`d:\SVN_OTHER\basic\api_swoole\index.php`

### 2.2 功能说明
框架的统一入口文件，负责初始化错误报告、加载框架核心、启动应用。

### 2.3 代码解析

```php
<?php
// 开启错误显示（开发环境）
ini_set('display_errors', 1);
ini_set('error_reporting', E_ALL);
ini_set('html_errors', 0);

// 加载框架核心
require_once __DIR__ . '/library/Cups.php';
use \Library\Cups;

// 设置时区
ini_set('date.timezone','Asia/Shanghai');

// 启动框架
try {
    Cups::run();
} catch (\Throwable $e) {
    // 异常处理：记录日志并输出错误
    $errorMessage = sprintf(
        "[%s] 框架启动异常: %s\n文件: %s\n行号: %d\n堆栈:\n%s",
        date('Y-m-d H:i:s'),
        $e->getMessage(),
        $e->getFile(),
        $e->getLine(),
        $e->getTraceAsString()
    );
    
    error_log($errorMessage, 3, __DIR__ . '/storage/logs/framework_error.log');
    echo "系统启动失败，请检查日志\n";
}
```

### 2.4 使用方法

```bash
# 启动服务
php index.php

# 或使用管理脚本
./cups.sh start
```

---

## 三、框架核心类 (Cups.php)

### 3.1 文件位置
`d:\SVN_OTHER\basic\api_swoole\library\Cups.php`

### 3.2 功能说明
框架主类，负责服务器生命周期管理、Worker 进程初始化、热重载监控等核心功能。

### 3.3 核心方法

#### 3.3.1 run() - 启动框架
```php
public static function run()
```
启动流程：
1. 加载环境变量 (.env)
2. 加载服务器配置
3. 创建 Swoole HTTP 服务器
4. 注册事件回调
5. 启动服务器

#### 3.3.2 onWorkerStart() - Worker 启动回调
```php
public static function onWorkerStart($server, $workerId)
```
初始化内容：
- 注册自动加载
- 加载配置文件
- 加载路由定义
- 初始化数据库连接池
- 初始化 Redis 连接池
- 启动热重载监控（仅 Worker 0）

#### 3.3.3 热重载机制
框架通过文件 MD5 监控实现热重载：
- 监控间隔：2 秒
- 监控范围：app/、library/、route/、config/ 目录
- 触发条件：文件 MD5 变化
- 执行动作：平滑重启 Worker 进程

---

## 四、服务器核心 (Core/Server)

### 4.1 BaseServer.php - 服务器基类

#### 功能说明
定义服务器基础接口和通用方法，支持多种协议的服务器实现。

#### 核心特性
- 服务器配置管理
- 进程管理（Worker、TaskWorker）
- 事件注册机制

### 4.2 ServerHttp.php - HTTP 服务器

#### 功能说明
处理 HTTP 请求的核心类，实现请求解析、路由分发、响应生成。

#### 核心流程
```
请求接收 → CORS 处理 → 请求解析 → 路由匹配 → 控制器执行 → 响应输出
```

#### 关键方法

**onRequest() - 请求处理入口**
```php
public static function onRequest($request, $response)
```

处理流程：
1. 生成请求 ID（X-Request-ID）
2. 初始化请求上下文
3. 记录请求开始时间
4. 执行路由分发
5. 捕获异常并格式化输出
6. 记录请求日志

**CORS 跨域配置**
```php
private static function setCorsHeaders($response)
```
支持通过 `config/server.php` 配置 CORS 响应头。

---

## 五、控制器基类 (BaseController)

### 5.1 文件位置
`d:\SVN_OTHER\basic\api_swoole\app\Base\BaseController.php`

### 5.2 功能说明
所有 HTTP 控制器的抽象基类，定义统一的执行流程和异常处理机制。

### 5.3 核心设计

```php
abstract class BaseController {
    protected $userId;
    
    // 统一执行入口
    public function __invoke() {
        $this->userId = Request::getTokenPayload('uid');
        try {
            $this->check();      // 参数校验
            $result = $this->service();  // 业务执行
            return $result;
        } catch (\Throwable $th) {
            DB::rollBack();      // 自动回滚事务
            $errorResult = Response::fail($th->getMessage());
            Log::exception($th); // 记录异常
            return $errorResult;
        }
    }
    
    // 子类必须实现
    protected abstract function check();
    protected abstract function service();
}
```

### 5.4 使用示例

```php
namespace App\Controller;

use App\Base\BaseController;
use Library\Facades\Request;
use Library\Facades\Response;
use Library\Facades\Validate;

class UserController extends BaseController {
    private $userId;
    private $username;
    
    protected function check() {
        // 参数验证
        Validate::validate([
            'user_id' => 'required|integer',
            'username' => 'required|string|max:50'
        ]);
        
        $this->userId = Request::post('user_id');
        $this->username = Request::post('username');
    }
    
    protected function service() {
        // 业务逻辑
        $userService = new \App\Service\UserService();
        $result = $userService->updateProfile($this->userId, $this->username);
        
        return Response::success($result);
    }
}
```

---

## 六、门面系统 (Facades)

### 6.1 设计模式
门面模式（Facade Pattern）为框架的子系统提供统一的简化接口。

### 6.2 门面类列表

| 门面类 | 功能 | 核心方法 |
|--------|------|----------|
| `DB` | 数据库操作 | `table()`, `select()`, `statement()`, `beginTransaction()` |
| `Request` | HTTP 请求 | `get()`, `post()`, `header()`, `getTokenPayload()` |
| `Response` | HTTP 响应 | `success()`, `fail()`, `json()`, `html()` |
| `Route` | 路由定义 | `get()`, `post()`, `group()`, `middleware()` |
| `Redis` | Redis 操作 | `get()`, `set()`, `hGet()`, `hSet()`, `expire()` |
| `Log` | 日志记录 | `debug()`, `info()`, `error()`, `exception()` |
| `Validate` | 数据验证 | `validate()` |

### 6.3 使用示例

```php
use Library\Facades\DB;
use Library\Facades\Request;
use Library\Facades\Response;
use Library\Facades\Log;

// 数据库查询
$user = DB::table('users')
    ->where('id', $id)
    ->where('status', 1)
    ->first();

// 获取请求参数
$userId = Request::get('user_id');
$token = Request::header('Authorization');

// 返回响应
return Response::success(['user' => $user]);

// 记录日志
Log::info('用户登录', ['user_id' => $userId]);
```

---

## 七、数据库系统 (Database)

### 7.1 架构设计

```
DB Facade → BuilderFactory → MysqlBuilder → DbPoolConn → PDO
```

### 7.2 连接池 (DbPoolConn)

基于 Swoole 协程通道实现的数据库连接池：
- 连接复用，减少连接开销
- 协程安全，自动上下文隔离
- 连接回收，防止资源泄漏

### 7.3 查询构建器 (MysqlBuilder)

支持链式调用的 SQL 构建器：

```php
// 基础查询
DB::table('users')
    ->where('status', 1)
    ->orderBy('created_at', 'desc')
    ->get();

// 分页查询
DB::table('users')
    ->where('status', 1)
    ->paginate(1, 20);  // 第1页，每页20条

// 聚合查询
DB::table('orders')
    ->where('status', 'paid')
    ->sum('amount');

// 事务处理
DB::beginTransaction();
try {
    DB::table('users')->insert(['name' => 'test']);
    DB::table('accounts')->where('user_id', 1)->update(['balance' => 100]);
    DB::commit();
} catch (\Exception $e) {
    DB::rollBack();
    throw $e;
}
```

---

## 八、路由系统 (Route)

### 8.1 文件位置
`d:\SVN_OTHER\basic\api_swoole\library\Route\Builder.php`

### 8.2 功能说明
灵活的路由定义系统，支持多种路由模式和中间件机制。

### 8.3 路由定义方式

```php
use Library\Facades\Route;

// 基础路由
Route::get('/users', 'UserController@index');
Route::post('/users', 'UserController@store');

// 路由参数
Route::get('/users/{id}', 'UserController@show');

// 路由组
Route::group(['prefix' => 'api', 'middleware' => ['auth']], function() {
    Route::get('/profile', 'UserController@profile');
    Route::post('/logout', 'AuthController@logout');
});

// WebSocket 路由
Route::setRequestType('websocket');
Route::get('/ws/chat', 'ChatController@handle');
```

### 8.4 路由匹配流程

1. 根据请求类型获取路由表（HTTP/WebSocket/TCP/UDP）
2. 按注册顺序匹配 URL 模式
3. 提取路径参数
4. 执行中间件链
5. 调用控制器

---

## 九、日志系统 (Log)

### 9.1 架构设计

基于 Swoole 协程通道的异步日志系统：
- 异步写入，不阻塞业务请求
- 多通道输出（文件、控制台）
- PSR-3 接口兼容

### 9.2 日志级别

```php
Log::emergency($message, $context);  // 系统不可用
Log::alert($message, $context);      // 必须立即处理
Log::critical($message, $context);   // 严重错误
Log::error($message, $context);      // 运行时错误
Log::warning($message, $context);    // 警告
Log::notice($message, $context);     // 通知
Log::info($message, $context);       // 信息
Log::debug($message, $context);      // 调试
```

### 9.3 PSR-3 支持

框架实现了 PSR-3 LoggerInterface：

```php
use Library\Log\PsrLogger;
use Psr\Log\LoggerInterface;

// 获取 PSR-3 兼容的日志实例
$logger = PsrLogger::getInstance();
$logger->info('用户操作', ['user_id' => 123]);
```

---

## 十、JWT 认证 (Core/Jwt)

### 10.1 功能说明
基于 JWT（JSON Web Token）的用户认证机制。

### 10.2 配置要求

在 `config/app.php` 或 `.env` 中配置：
```php
return [
    'jwt_key' => 'your-secret-key-here',  // 必须配置，不能使用默认值
    'token_expire' => 7200,  // token 有效期（秒）
];
```

### 10.3 使用方法

```php
use Library\Core\Jwt;

// 生成 Token
$token = Jwt::getToken([
    'uid' => $userId,
    'username' => $username
]);

// 验证 Token
try {
    Jwt::verifyToken($token);
} catch (\Exception $e) {
    // Token 无效或过期
}

// 获取 Payload
$payload = Jwt::getPayLoad($token);
$userId = $payload['uid'];
```

---

## 十一、PSR 标准支持

### 11.1 PSR-3 日志接口

框架实现了 PSR-3 LoggerInterface：
- 文件：`library/Log/PsrLogger.php`
- 支持 8 个日志级别
- 上下文数据插值
- 符合 PSR-3 规范

### 11.2 PSR-4 自动加载

通过 Composer 配置 PSR-4 自动加载：
```json
{
    "autoload": {
        "psr-4": {
            "App\\": "app/",
            "Library\\": "library/"
        }
    }
}
```

---

## 十二、配置系统

### 12.1 配置文件位置
`d:\SVN_OTHER\basic\api_swoole\config\`

### 12.2 配置加载

```php
use Library\Core\Config;

// 获取配置
$dbConfig = Config::get('database');
$host = Config::get('database.host');

// 设置配置
Config::set('app.debug', true);
```

### 12.3 环境变量

支持 `.env` 文件加载环境变量：
```
APP_ENV=development
DB_HOST=localhost
DB_PORT=3306
REDIS_HOST=127.0.0.1
```

---

## 十三、服务管理脚本

### 13.1 脚本位置
`d:\SVN_OTHER\basic\api_swoole\cups.sh`

### 13.2 命令列表

```bash
# 启动服务
./cups.sh start

# 停止服务
./cups.sh stop

# 重启服务
./cups.sh restart

# 平滑重载
./cups.sh reload

# 查看状态
./cups.sh status
```

---

## 十四、开发规范

### 14.1 命名规范

- **类名**：大驼峰（`UserController`）
- **方法名**：小驼峰（`getUserInfo`）
- **变量名**：小驼峰（`$userId`）
- **常量名**：全大写下划线（`MAX_RETRY_COUNT`）
- **文件名**：与类名一致

### 14.2 代码规范

- 使用 PHP 8.0+ 类型声明
- 函数必须添加 PHPDoc 注释
- 异常必须捕获并记录
- 数据库操作使用参数绑定防止 SQL 注入

### 14.3 目录规范

- 控制器：`app/Controller/`
- 服务层：`app/Service/`
- 模型层：`app/Model/`
- 路由定义：`route/`
- 配置文件：`config/`

---

## 十五、性能优化建议

1. **使用连接池**：数据库和 Redis 操作都通过连接池
2. **启用热重载**：开发环境开启，生产环境关闭
3. **合理设置 Worker 数**：通常设置为 CPU 核数的 2-4 倍
4. **使用协程**：IO 操作使用协程版本
5. **日志异步化**：日志通过协程通道异步写入

---

## 十六、安全注意事项

1. **JWT 密钥**：必须配置强密钥，不能使用默认值
2. **SQL 注入**：使用查询构建器或参数绑定
3. **XSS 防护**：输出数据时进行转义
4. **CSRF 防护**：敏感操作添加 CSRF Token
5. **文件权限**：日志目录设置适当权限（755）

---

## 十七、故障排查

### 17.1 常见问题

**服务启动失败**
- 检查 Swoole 扩展是否安装
- 检查端口是否被占用
- 查看 `storage/logs/` 目录的错误日志

**数据库连接失败**
- 检查数据库配置
- 确认连接池配置正确
- 检查数据库服务状态

**内存溢出**
- 调整 Swoole 内存限制
- 检查是否有内存泄漏
- 优化大数据量查询

### 17.2 日志位置

- 框架错误：`storage/logs/framework_error.log`
- 应用日志：`storage/logs/YYYY-MM-DD.log`
- 紧急日志：`storage/logs/emergency.log`

---

## 十八、版本历史

### v1.0.0 (当前版本)
- 基础框架功能
- HTTP/WebSocket 支持
- 连接池实现
- 门面系统
- 路由系统
- 日志系统
- PSR-3/PSR-4 支持
- 热重载机制
